# FaceFusion 用户使用手册

## 项目简介

FaceFusion 是一个强大的人脸处理平台，支持换脸、人脸增强、年龄修改、表情恢复等多种功能。本手册将指导您如何使用这个已经汉化和优化的版本。

**项目地址**: https://github.com/kegeai888/facefusion
**视频教程**: https://g1hzbw0p4dd.feishu.cn/docx/E1bBdyvUroOSh7x69EEc9AyDnDf?from=from_copylink

---

## 快速开始

### 启动应用

在项目目录下运行：

```bash
./start_app.sh
```

应用启动后会自动打开浏览器，访问地址：http://localhost:7860

如果浏览器没有自动打开，请手动访问上述地址。

---

## 界面说明

### 主界面布局

FaceFusion 的主界面分为以下几个部分：

1. **源素材区域** - 上传源人脸图片
2. **目标素材区域** - 上传要处理的目标图片或视频
3. **处理器选择** - 选择要使用的处理功能
4. **参数配置** - 调整各处理器的参数
5. **输出设置** - 设置输出文件的质量和格式
6. **预览区域** - 实时预览处理效果
7. **控制按钮** - 开始、停止处理

---

## 核心功能使用

### 1. 换脸功能（换脸器）

**用途**: 将源人脸替换到目标图片或视频中

**使用步骤**:

1. **上传源素材**
   - 点击"源素材"区域
   - 选择包含源人脸的图片
   - 确保人脸清晰可见

2. **上传目标素材**
   - 点击"目标素材"区域
   - 选择要替换人脸的图片或视频

3. **选择处理器**
   - 在"处理器"区域勾选"换脸器"
   - 可以同时勾选"人脸增强器"以提升效果

4. **调整参数**（可选）
   - **换脸模型**: 选择换脸算法（推荐使用默认）
   - **换脸权重**: 调整换脸强度（0.0-1.0，默认 1.0）
   - **像素增强**: 选择分辨率增强级别

5. **开始处理**
   - 点击"开始"按钮
   - 等待处理完成
   - 在输出路径查看结果

**参数说明**:
- **换脸权重**: 值越大，换脸效果越明显；值越小，保留更多原始特征
- **像素增强**: 提高输出分辨率，但会增加处理时间

---

### 2. 人脸增强（人脸增强器）

**用途**: 提升人脸清晰度和质量

**使用步骤**:

1. 上传目标素材（包含人脸的图片或视频）
2. 勾选"人脸增强器"
3. 调整增强参数：
   - **增强模型**: 选择增强算法
   - **混合比例**: 控制增强强度（0.0-1.0）
   - **增强权重**: 调整增强效果的权重

4. 点击"开始"处理

**使用场景**:
- 提升低分辨率人脸的清晰度
- 改善模糊或失焦的人脸
- 配合换脸功能使用，提升最终效果

---

### 3. 年龄修改（年龄修改器）

**用途**: 调整人脸的年龄外观

**使用步骤**:

1. 上传目标素材
2. 勾选"年龄修改器"
3. 选择年龄方向：
   - **变年轻**: 减少年龄特征
   - **变年长**: 增加年龄特征
4. 调整修改强度
5. 开始处理

**注意事项**:
- 年龄修改效果因原始人脸特征而异
- 建议配合人脸增强器使用

---

### 4. 表情恢复（表情恢复器）

**用途**: 恢复或增强人脸表情

**使用步骤**:

1. 上传目标素材
2. 勾选"表情恢复器"
3. 选择要恢复的区域（眼睛、嘴巴等）
4. 调整恢复强度
5. 开始处理

**适用场景**:
- 修复表情僵硬的人脸
- 增强微表情
- 改善换脸后的表情自然度

---

### 5. 背景移除（背景移除器）

**用途**: 移除或替换图片背景

**使用步骤**:

1. 上传目标素材
2. 勾选"背景移除器"
3. 选择背景处理方式：
   - **透明背景**: 移除背景，保留透明
   - **纯色背景**: 替换为指定颜色
4. 设置背景颜色（如果选择纯色）
5. 开始处理

---

### 6. 其他处理器

#### 深度换脸器
- 使用深度学习算法进行更精确的换脸
- 适合复杂场景和多角度人脸

#### 人脸调试器
- 显示人脸检测和关键点信息
- 用于调试和验证人脸识别效果

#### 人脸编辑器
- 精细调整人脸特征
- 包括眼睛、嘴巴、头部姿态等

#### 帧上色器
- 为黑白视频添加颜色
- 自动识别和上色

#### 帧增强器
- 提升整体视频质量
- 增强清晰度和细节

#### 唇形同步器
- 同步音频和唇形动作
- 适用于配音和翻译场景

---

## 高级功能

### 组合使用多个处理器

FaceFusion 支持同时使用多个处理器，按顺序处理：

**推荐组合**:

1. **高质量换脸**:
   - 换脸器 + 人脸增强器
   - 先换脸，再增强，效果更自然

2. **年轻化处理**:
   - 年龄修改器 + 人脸增强器 + 表情恢复器
   - 全面提升人脸质量

3. **专业级处理**:
   - 深度换脸器 + 表情恢复器 + 人脸增强器
   - 适合高要求场景

**使用方法**:
- 在"处理器"区域同时勾选多个处理器
- 系统会按照预设顺序依次处理
- 每个处理器都可以单独配置参数

---

## 参数配置详解

### 人脸检测参数

**人脸检测模型**:
- 选择人脸检测算法
- 推荐使用默认设置

**人脸检测角度**:
- 0°: 正面人脸
- ±90°: 侧面人脸
- 勾选多个角度可以检测不同朝向的人脸

**人脸检测置信度**:
- 控制检测灵敏度
- 值越高，检测越严格
- 推荐值：0.5-0.7

**人脸检测边距**:
- 扩大人脸检测区域
- 包含更多周边信息
- 推荐值：10-20

### 人脸选择参数

**人脸选择模式**:
- **参考人脸**: 选择与参考最相似的人脸
- **所有人脸**: 处理所有检测到的人脸
- **特定人脸**: 根据位置选择人脸

**人脸选择顺序**:
- **从左到右**: 按位置排序
- **从右到左**: 反向排序
- **从大到小**: 按人脸大小排序
- **从小到大**: 反向大小排序

**年龄范围**:
- 筛选特定年龄段的人脸
- 范围：0-100 岁

**性别选择**:
- 男性、女性或全部

**人种选择**:
- 筛选特定人种的人脸

### 人脸遮罩参数

**遮罩类型**:
- **遮挡**: 使用遮挡模型（推荐 xseg_3）
- **分割**: 使用分割模型
- **区域**: 基于区域的遮罩

**遮罩区域**:
- 选择要处理的人脸区域
- 可以排除某些区域（如眼睛、嘴巴）

**遮罩模糊**:
- 控制遮罩边缘的柔和度
- 值越大，边缘越柔和
- 推荐值：10-30

**遮罩边距**:
- 调整遮罩的上下左右边距
- 扩大或缩小处理区域

### 输出参数

**图像质量**:
- 控制输出图片的压缩质量
- 范围：0-100
- 推荐值：80-95

**图像缩放**:
- 调整输出图片的分辨率
- 100% = 原始分辨率
- 可以放大或缩小

**视频编码器**:
- 选择视频编码格式
- 推荐：H.264 或 H.265

**视频质量**:
- 控制视频压缩质量
- 范围：0-100
- 推荐值：80-90

**视频帧率**:
- 设置输出视频的帧率
- 推荐保持与原视频一致

---

## 使用技巧

### 1. 获得最佳换脸效果

**源素材选择**:
- 选择高清、正面、光线充足的照片
- 人脸表情自然，无遮挡
- 与目标人脸角度相近

**参数调整**:
- 换脸权重：从 0.8 开始调整
- 启用像素增强：选择 512x512 或更高
- 配合人脸增强器使用

**后期优化**:
- 使用表情恢复器改善表情
- 调整遮罩参数优化边缘
- 多次尝试不同参数组合

### 2. 处理视频的注意事项

**性能优化**:
- 视频处理需要较长时间
- 建议先用单帧测试效果
- 确认参数后再处理完整视频

**质量设置**:
- 保持原视频的分辨率和帧率
- 使用高质量编码器
- 预留足够的磁盘空间

**分段处理**:
- 长视频可以分段处理
- 使用裁剪帧功能选择处理范围
- 分别处理后再合并

### 3. 常见问题解决

**问题：检测不到人脸**
- 解决：降低人脸检测置信度
- 解决：增加检测角度选项
- 解决：提高源图片质量

**问题：换脸效果不自然**
- 解决：降低换脸权重
- 解决：调整遮罩参数
- 解决：使用表情恢复器

**问题：处理速度慢**
- 解决：降低输出分辨率
- 解决：减少同时使用的处理器
- 解决：使用 GPU 加速（TensorRT）

**问题：输出文件过大**
- 解决：降低输出质量参数
- 解决：使用更高效的编码器
- 解决：调整输出分辨率

---

## 工作流程示例

### 示例 1：照片换脸

1. 准备素材：
   - 源人脸照片（高清正面照）
   - 目标照片

2. 配置参数：
   - 勾选：换脸器 + 人脸增强器
   - 换脸权重：0.85
   - 像素增强：512x512
   - 增强混合：0.8

3. 处理流程：
   - 上传源素材和目标素材
   - 点击"开始"
   - 等待处理完成
   - 查看预览效果
   - 如需调整，修改参数后重新处理

4. 输出设置：
   - 图像质量：90
   - 图像缩放：100%
   - 输出路径：outputs/result.jpg

### 示例 2：视频换脸

1. 准备素材：
   - 源人脸照片
   - 目标视频

2. 测试阶段：
   - 使用预览功能测试单帧
   - 调整参数直到满意
   - 记录最佳参数组合

3. 正式处理：
   - 应用测试阶段的参数
   - 勾选：换脸器 + 人脸增强器 + 表情恢复器
   - 设置输出视频参数
   - 开始处理

4. 质量检查：
   - 播放输出视频
   - 检查关键帧效果
   - 如有问题，调整参数重新处理

### 示例 3：批量处理

1. 准备素材：
   - 一个源人脸照片
   - 多个目标照片或视频

2. 使用批处理模式：
   - 设置源素材路径模式
   - 设置目标素材路径模式
   - 设置输出路径模式
   - 配置统一的处理参数

3. 执行批处理：
   - 使用命令行批处理功能
   - 或使用 Job 系统创建批处理任务
   - 监控处理进度

---

## 命令行使用

### 基本命令

```bash
# 单次处理
./run_facefusion.sh headless-run \
  -s source.jpg \
  -t target.mp4 \
  -o output.mp4 \
  --processors face_swapper face_enhancer

# 批量处理
./run_facefusion.sh batch-run \
  -s "sources/*.jpg" \
  -t "targets/*.mp4" \
  -o "outputs/{index}.mp4" \
  --processors face_swapper
```

### 常用参数

```bash
# 指定处理器
--processors face_swapper face_enhancer

# 设置换脸模型
--face-swapper-model inswapper_128

# 设置输出质量
--output-video-quality 90

# 设置执行设备
--execution-device-ids 0

# 设置执行提供器
--execution-providers tensorrt cuda
```

---

## 性能优化建议

### GPU 加速

本版本已配置 TensorRT 加速：

- **自动启用**: 使用 `./run_facefusion.sh` 启动时自动启用
- **加速效果**: 处理速度提升 2-5 倍
- **首次运行**: 会生成引擎缓存，需要较长时间
- **后续运行**: 直接使用缓存，速度很快

### 内存管理

**系统内存限制**:
- 在配置中设置最大内存使用量
- 防止系统内存耗尽
- 推荐设置为系统内存的 70-80%

**显存管理**:
- 降低批处理大小
- 使用较小的模型
- 关闭不必要的处理器

### 处理速度优化

**提升速度的方法**:
1. 使用 GPU 加速（TensorRT）
2. 降低输出分辨率
3. 减少同时使用的处理器
4. 使用较小的模型
5. 调整线程数量

**平衡质量和速度**:
- 测试阶段使用低质量快速预览
- 正式处理使用高质量参数
- 根据需求选择合适的模型

---

## 常见问题 FAQ

### Q1: 如何获得最佳换脸效果？

**A**:
- 使用高质量的源人脸照片（高清、正面、光线好）
- 启用人脸增强器
- 调整换脸权重（0.8-0.95）
- 使用像素增强功能
- 配合表情恢复器使用

### Q2: 为什么检测不到人脸？

**A**:
- 降低人脸检测置信度（0.5-0.6）
- 增加检测角度选项（勾选 ±90°）
- 确保照片中人脸清晰可见
- 检查照片分辨率是否过低

### Q3: 处理速度太慢怎么办？

**A**:
- 确保使用 `./run_facefusion.sh` 启动（启用 TensorRT）
- 降低输出分辨率
- 减少同时使用的处理器
- 使用较小的模型
- 增加执行线程数

### Q4: 换脸后边缘不自然怎么办？

**A**:
- 调整遮罩模糊参数（增加到 20-30）
- 调整遮罩边距
- 降低换脸权重
- 使用表情恢复器
- 尝试不同的遮罩类型

### Q5: 如何处理多人场景？

**A**:
- 使用"所有人脸"模式
- 或使用参考人脸模式指定要处理的人脸
- 调整人脸选择参数（年龄、性别等）
- 可以多次处理，每次处理不同的人脸

### Q6: 输出视频文件太大怎么办？

**A**:
- 降低输出质量参数（70-80）
- 使用 H.265 编码器（压缩率更高）
- 调整输出分辨率
- 使用更高效的视频预设

### Q7: 如何保存和复用参数配置？

**A**:
- 修改 `facefusion.ini` 配置文件
- 设置默认参数
- 使用 Job 系统保存处理流程
- 记录成功的参数组合

### Q8: 遇到错误如何排查？

**A**:
- 查看应用日志：`app.log`
- 检查模型文件是否完整
- 确认输入文件格式正确
- 检查磁盘空间是否充足
- 查看终端输出的错误信息

---

## 获取帮助

### 视频教程

详细的视频教程请访问：
https://g1hzbw0p4dd.feishu.cn/docx/E1bBdyvUroOSh7x69EEc9AyDnDf?from=from_copylink

### 项目地址

GitHub 仓库：https://github.com/kegeai888/facefusion

### 联系方式

- **开发者**: 科哥
- **邮箱**: ihuangke222@gmail.com

---

## 附录

### 支持的文件格式

**图片格式**:
- JPG/JPEG
- PNG
- BMP
- WEBP

**视频格式**:
- MP4
- AVI
- MOV
- MKV
- WEBM

**音频格式**:
- MP3
- WAV
- AAC
- FLAC

### 系统要求

**最低配置**:
- CPU: 4 核心
- 内存: 8GB
- 显卡: 支持 CUDA 的 NVIDIA 显卡（可选）
- 磁盘: 20GB 可用空间

**推荐配置**:
- CPU: 8 核心或更多
- 内存: 16GB 或更多
- 显卡: NVIDIA RTX 系列（支持 TensorRT）
- 磁盘: 50GB 或更多 SSD

### 模型文件说明

模型文件存储在 `.assets/models/` 目录：

- **换脸模型**: inswapper_128, ghost 系列等
- **增强模型**: gfpgan, codeformer 等
- **检测模型**: yoloface, retinaface 等
- **其他模型**: 各处理器专用模型

首次使用某个模型时会自动下载，请确保网络连接正常。

---

**最后更新**: 2026-01-29
**版本**: 3.5.2 (汉化定制版)
**维护者**: 科哥 (kegeai888)
